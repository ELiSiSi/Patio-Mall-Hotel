extends base

block content
  main.admin-main

    //- ===== PAGE TITLE =====
    .page-title-bar
      .page-title-info
        h1
          i(class="fa-solid fa-bed" style="margin-left:10px; color:#f43f5e;")
          | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù
        p.page-subtitle Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„ØºØ±Ù Ø§Ù„ÙÙ†Ø¯Ù‚ÙŠØ©

      button.add-room-btn(onclick="openAddModal()")
        i(class="fa-solid fa-plus")
        span Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©

    //- ===== STATS =====
    .stats-grid
      .stat-card.stat-total
        .stat-icon
          i(class="fa-solid fa-bed")
        .stat-info
          span.stat-label Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºØ±Ù
          span.stat-value= rooms.length

      .stat-card.stat-confirmed
        .stat-icon
          i(class="fa-solid fa-tag")
        .stat-info
          span.stat-label Ø£Ù‚Ù„ Ø³Ø¹Ø±
          span.stat-value
            if rooms.length > 0
              | #{Math.min(...rooms.map(r => r.price || 0))} Ø¬
            else
              | â€”

      .stat-card.stat-pending
        .stat-icon
          i(class="fa-solid fa-sack-dollar")
        .stat-info
          span.stat-label Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±
          span.stat-value
            if rooms.length > 0
              | #{Math.max(...rooms.map(r => r.price || 0))} Ø¬
            else
              | â€”

      .stat-card.stat-cancelled
        .stat-icon
          i(class="fa-solid fa-calculator")
        .stat-info
          span.stat-label Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±
          span.stat-value
            if rooms.length > 0
              | #{Math.round(rooms.reduce((s,r)=>s+(r.price||0),0)/rooms.length)} Ø¬
            else
              | â€”

    //- ===== SEARCH =====
    .table-controls
      .search-box
        i(class="fa-solid fa-magnifying-glass search-icon")
        input#searchInput(type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©...")

    //- ===== TABLE =====
    .table-wrapper
      if rooms.length === 0
        .empty-state
          i(class="fa-solid fa-bed")
          p Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
          button.add-room-btn(onclick="openAddModal()" style="margin:16px auto 0; display:inline-flex;")
            i(class="fa-solid fa-plus")
            span Ø£Ø¶Ù Ø£ÙˆÙ„ ØºØ±ÙØ©
      else
        table.bookings-table#roomsTable
          thead
            tr
              th #
              th Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©
              th Ø§Ù„Ø³Ø¹Ø± (Ø¬/Ù„ÙŠÙ„Ø©)
              th Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª

          tbody
            each room, index in rooms
              tr.room-row(data-name=(room.name || '').toLowerCase())
                td.td-num= index + 1

                td
                  .client-info
                    .client-avatar= (room.name || 'Øº').charAt(0)
                    strong= room.name

                td
                  span.room-price-badge
                    i(class="fa-solid fa-tag" style="margin-left:5px; font-size:11px;")
                    | #{room.price} Ø¬

                td.td-actions
                  button.action-btn.btn-edit(
                    title="ØªØ¹Ø¯ÙŠÙ„"
                    data-id=room._id
                    data-name=room.name
                    data-price=room.price
                  )
                    i(class="fa-solid fa-pen-to-square")

                  button.action-btn.btn-delete(
                    title="Ø­Ø°Ù"
                    onclick=`deleteRoom('${room._id}', '${room.name}')`
                  )
                    i(class="fa-solid fa-trash")

    //- ===== MODAL =====
    #roomModal.modal-overlay(style="display:none;")
      .modal-card
        .modal-header
          h3#modalTitle
            i(class="fa-solid fa-bed" style="margin-left:8px;")
            | Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
          button.modal-close(onclick="closeModal()")
            i(class="fa-solid fa-xmark")

        .modal-body
          .form-group
            label(for="roomName") Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© *
            .input-with-icon
              input#roomName.form-input(type="text" placeholder="Ù…Ø«Ø§Ù„: ØºØ±ÙØ© Ø¯ÙŠÙ„ÙˆÙƒØ³")
              i(class="fa-solid fa-bed input-icon")

          .form-group
            label(for="roomPrice") Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ù„ÙŠÙ„Ø© (Ø¬) *
            .input-with-icon
              input#roomPrice.form-input(type="number" placeholder="500" min="0")
              i(class="fa-solid fa-tag input-icon")

          input#roomId(type="hidden")

          .modal-actions
            button.modal-action-btn.btn-modal-confirm(type="button" onclick="saveRoom()")
              i(class="fa-solid fa-floppy-disk")
              span Ø­ÙØ¸
            button.modal-action-btn.btn-modal-cancel(type="button" onclick="closeModal()")
              i(class="fa-solid fa-xmark")
              span Ø¥Ù„ØºØ§Ø¡

    //- ===== TOAST =====
    #toast-container

  script.
    // Toast
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      const icons = { error:'fa-circle-exclamation', warning:'fa-triangle-exclamation', success:'fa-circle-check', info:'fa-circle-info' };
      toast.innerHTML = `<div class="toast-content"><i class="fa-solid ${icons[type]} toast-icon"></i><span class="toast-message">${message}</span></div><div class="toast-progress"></div>`;
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 4000);
    }

    // Search
    document.getElementById('searchInput').addEventListener('input', function() {
      const q = this.value.toLowerCase();
      document.querySelectorAll('.room-row').forEach(row => {
        row.style.display = row.dataset.name.includes(q) ? '' : 'none';
      });
    });

    // Open Add
    function openAddModal() {
      document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-plus" style="margin-left:8px;"></i> Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©';
      document.getElementById('roomId').value    = '';
      document.getElementById('roomName').value  = '';
      document.getElementById('roomPrice').value = '';
      document.getElementById('roomModal').style.display = 'flex';
      setTimeout(() => document.getElementById('roomName').focus(), 100);
    }

    // Open Edit
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', function() {
        document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-pen-to-square" style="margin-left:8px;"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØºØ±ÙØ©';
        document.getElementById('roomId').value    = this.dataset.id;
        document.getElementById('roomName').value  = this.dataset.name;
        document.getElementById('roomPrice').value = this.dataset.price;
        document.getElementById('roomModal').style.display = 'flex';
        setTimeout(() => document.getElementById('roomName').focus(), 100);
      });
    });

    function closeModal() {
      document.getElementById('roomModal').style.display = 'none';
    }
    document.getElementById('roomModal').addEventListener('click', e => { if (e.target === document.getElementById('roomModal')) closeModal(); });

    // Save
    async function saveRoom() {
      const id    = document.getElementById('roomId').value;
      const name  = document.getElementById('roomName').value.trim();
      const price = document.getElementById('roomPrice').value;

      if (!name)  { showToast('âœï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©', 'warning'); return; }
      if (!price || Number(price) <= 0) { showToast('ğŸ’° Ø§ÙƒØªØ¨ Ø³Ø¹Ø± ØµØ­ÙŠØ­', 'warning'); return; }

      const isEdit = !!id;
      const url    = isEdit ? `/api/v1/room/${id}` : '/api/v1/room';
      const method = isEdit ? 'PATCH' : 'POST';

      try {
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, price: Number(price) })
        });
        if (res.ok) {
          showToast(isEdit ? 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±ÙØ©' : 'âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØºØ±ÙØ©', 'success');
          closeModal();
          setTimeout(() => location.reload(), 1200);
        } else {
          const err = await res.json();
          showToast('âŒ ' + (err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£'), 'error');
        }
      } catch { showToast('âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error'); }
    }

    // Delete
    async function deleteRoom(id, name) {
      if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ØºØ±ÙØ© "${name}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) return;
      try {
        const res = await fetch(`/api/v1/room/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©', 'success');
          setTimeout(() => location.reload(), 1200);
        } else {
          showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
        }
      } catch { showToast('âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„', 'error'); }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && document.getElementById('roomModal').style.display === 'flex') saveRoom();
      if (e.key === 'Escape') closeModal();
    });
