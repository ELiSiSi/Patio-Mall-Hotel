extends base

block content
  main.admin-main

    //- ===== HEADER =====
    .admin-header
      .admin-header-right
        .admin-logo
          i(class="fa-solid fa-shield-halved")
          span Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        h1.admin-page-title
          i(class="fa-solid fa-calendar-lines" style="margin-left:10px;")
          | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
      .admin-header-left
        span.admin-date#currentDate
        a.admin-back-btn(href="/")
          i(class="fa-solid fa-arrow-right" style="margin-left:6px;")
          | Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

    //- ===== STATS CARDS =====
    .stats-grid
      .stat-card.stat-total
        .stat-icon
          i(class="fa-solid fa-calendar-check")
        .stat-info
          span.stat-label Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
          span.stat-value= bookings.length

      .stat-card.stat-pending
        .stat-icon
          i(class="fa-solid fa-clock")
        .stat-info
          span.stat-label Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
          span.stat-value= bookings.filter(b => b.status === 'pending').length

      .stat-card.stat-confirmed
        .stat-icon
          i(class="fa-solid fa-circle-check")
        .stat-info
          span.stat-label Ù…Ø¤ÙƒØ¯Ø©
          span.stat-value= bookings.filter(b => b.status === 'confirmed').length

      .stat-card.stat-cancelled
        .stat-icon
          i(class="fa-solid fa-circle-xmark")
        .stat-info
          span.stat-label Ù…Ù„ØºÙŠØ©
          span.stat-value= bookings.filter(b => b.status === 'cancelled').length

    //- ===== FILTERS & SEARCH =====
    .table-controls
      .search-box
        i(class="fa-solid fa-magnifying-glass search-icon")
        input#searchInput(type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ...")

      .filter-group
        button.filter-btn.active(data-filter="all") Ø§Ù„ÙƒÙ„
        button.filter-btn(data-filter="pending") Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        button.filter-btn(data-filter="confirmed") Ù…Ø¤ÙƒØ¯Ø©
        button.filter-btn(data-filter="cancelled") Ù…Ù„ØºÙŠØ©

      .type-filter-group
        button.type-btn.active(data-type="all") Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        button.type-btn(data-type="room")
          i(class="fa-solid fa-bed")
          |  ØºØ±ÙØ©
        button.type-btn(data-type="event")
          i(class="fa-solid fa-champagne-glasses")
          |  Ù…Ù†Ø§Ø³Ø¨Ø©
        button.type-btn(data-type="cottage")
          i(class="fa-solid fa-house-chimney-window")
          |  ÙƒÙˆØ®

    //- ===== TABLE =====
    .table-wrapper
      if bookings.length === 0
        .empty-state
          i(class="fa-solid fa-calendar-xmark")
          p Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
      else
        table.bookings-table#bookingsTable
          thead
            tr
              th #
              th Ø§Ù„Ø¹Ù…ÙŠÙ„
              th Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¬Ø²
              th ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØµÙˆÙ„
              th ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©
              th Ø§Ù„Ø£Ø´Ø®Ø§Øµ
              th Ø§Ù„Ø­Ø§Ù„Ø©
              th Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª

          tbody
            each booking, index in bookings
              tr.booking-row(
                data-status=booking.status
                data-type=booking.bookingType
                data-name=booking.name
                data-phone=booking.phone
              )
                td.td-num= index + 1

                td.td-client
                  .client-info
                    .client-avatar= booking.name.charAt(0)
                    .client-details
                      strong= booking.name
                      span= booking.phone

                td.td-type
                  if booking.bookingType === 'room'
                    span.type-badge.type-room
                      i(class="fa-solid fa-bed")
                      |  ØºØ±ÙØ© ÙÙ†Ø¯Ù‚ÙŠØ©
                  else if booking.bookingType === 'event'
                    span.type-badge.type-event
                      i(class="fa-solid fa-champagne-glasses")
                      |  Ù…Ù†Ø§Ø³Ø¨Ø©
                  else if booking.bookingType === 'cottage'
                    span.type-badge.type-cottage
                      i(class="fa-solid fa-house-chimney-window")
                      |  ÙƒÙˆØ® Ø®Ø§Øµ

                td.td-date
                  if booking.checkIn
                    span= new Date(booking.checkIn).toLocaleDateString('ar-EG', {year:'numeric', month:'short', day:'numeric'})
                  else
                    span.text-muted â€”

                td.td-date
                  if booking.checkOut
                    span= new Date(booking.checkOut).toLocaleDateString('ar-EG', {year:'numeric', month:'short', day:'numeric'})
                  else
                    span.text-muted â€”

                td.td-num= booking.numbers || 'â€”'

                td.td-status
                  span.status-badge(class=`status-${booking.status}`)
                    if booking.status === 'pending'
                      i(class="fa-solid fa-clock")
                      |  Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                    else if booking.status === 'confirmed'
                      i(class="fa-solid fa-circle-check")
                      |  Ù…Ø¤ÙƒØ¯
                    else if booking.status === 'cancelled'
                      i(class="fa-solid fa-circle-xmark")
                      |  Ù…Ù„ØºÙŠ

                td.td-actions
                  button.action-btn.btn-view(
                    title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„"
                    data-id=booking._id
                    data-name=booking.name
                    data-phone=booking.phone
                    data-type=booking.bookingType
                    data-checkin=booking.checkIn
                    data-checkout=booking.checkOut
                    data-numbers=booking.numbers
                    data-rooms=booking.rooms
                    data-message=booking.message
                    data-status=booking.status
                    data-roomtype=(booking.roomType || '')
                    data-eventtype=(booking.eventType || '')
                    data-createdat=booking.createdAt
                  )
                    i(class="fa-solid fa-eye")

                  button.action-btn.btn-confirm(
                    title="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²"
                    data-id=booking._id
                    onclick=`updateStatus('${booking._id}', 'confirmed')`
                  )
                    i(class="fa-solid fa-check")

                  button.action-btn.btn-cancel(
                    title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²"
                    data-id=booking._id
                    onclick=`updateStatus('${booking._id}', 'cancelled')`
                  )
                    i(class="fa-solid fa-xmark")

                  button.action-btn.btn-delete(
                    title="Ø­Ø°Ù"
                    data-id=booking._id
                    onclick=`deleteBooking('${booking._id}')`
                  )
                    i(class="fa-solid fa-trash")

    //- ===== MODAL: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² =====
    #detailsModal.modal-overlay(style="display:none;")
      .modal-card
        .modal-header
          h3
            i(class="fa-solid fa-file-lines" style="margin-left:8px;")
            | ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²
          button.modal-close(onclick="closeModal()")
            i(class="fa-solid fa-xmark")
        .modal-body#modalBody

    //- ===== TOAST =====
    #toast-container

  script.
    // ===== Date =====
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ar-EG', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    // ===== Toast =====
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      const icons = { error: 'fa-circle-exclamation', warning: 'fa-triangle-exclamation', success: 'fa-circle-check', info: 'fa-circle-info' };
      toast.innerHTML = `
        <div class="toast-content">
          <i class="fa-solid ${icons[type]} toast-icon"></i>
          <span class="toast-message">${message}</span>
        </div>
        <div class="toast-progress"></div>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 4000);
    }

    // ===== Search & Filter =====
    const searchInput = document.getElementById('searchInput');
    let activeStatus = 'all';
    let activeType = 'all';

    function applyFilters() {
      const q = searchInput.value.trim().toLowerCase();
      document.querySelectorAll('.booking-row').forEach(row => {
        const name   = (row.dataset.name || '').toLowerCase();
        const phone  = (row.dataset.phone || '').toLowerCase();
        const status = row.dataset.status;
        const type   = row.dataset.type;

        const matchSearch = !q || name.includes(q) || phone.includes(q);
        const matchStatus = activeStatus === 'all' || status === activeStatus;
        const matchType   = activeType === 'all' || type === activeType;

        row.style.display = matchSearch && matchStatus && matchType ? '' : 'none';
      });
    }

    searchInput.addEventListener('input', applyFilters);

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        activeStatus = this.dataset.filter;
        applyFilters();
      });
    });

    document.querySelectorAll('.type-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        activeType = this.dataset.type;
        applyFilters();
      });
    });

    // ===== View Details Modal =====
    document.querySelectorAll('.btn-view').forEach(btn => {
      btn.addEventListener('click', function() {
        const d = this.dataset;
        const typeLabels = { room: 'ğŸ¨ ØºØ±ÙØ© ÙÙ†Ø¯Ù‚ÙŠØ©', event: 'ğŸ¥‚ Ù…Ù†Ø§Ø³Ø¨Ø© Ø®Ø§ØµØ©', cottage: 'ğŸ¡ ÙƒÙˆØ® Ø®Ø§Øµ' };
        const statusLabels = { pending: 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', confirmed: 'âœ… Ù…Ø¤ÙƒØ¯', cancelled: 'âŒ Ù…Ù„ØºÙŠ' };
        const fmt = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('ar-EG', {year:'numeric', month:'long', day:'numeric'}) : 'â€”';

        let extraHTML = '';
        if (d.type === 'room' && d.roomtype) {
          extraHTML = `<div class="detail-row"><span>Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ©</span><strong>${d.roomtype}</strong></div>`;
        } else if (d.type === 'event' && d.eventtype) {
          const eTypes = { wedding:'Ø­ÙÙ„ Ø²ÙØ§Ù', engagement:'Ø®Ø·ÙˆØ¨Ø©', birthday:'Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯', anniversary:'Ø°ÙƒØ±Ù‰ Ø³Ù†ÙˆÙŠØ©', corporate:'Ø­Ø¯Ø« Ø´Ø±ÙƒØ§Øª', photo:'Ø¬Ù„Ø³Ø© ØªØµÙˆÙŠØ±', other:'Ø£Ø®Ø±Ù‰' };
          extraHTML = `<div class="detail-row"><span>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</span><strong>${eTypes[d.eventtype] || d.eventtype}</strong></div>`;
        }

        document.getElementById('modalBody').innerHTML = `
          <div class="detail-grid">
            <div class="detail-row"><span>Ø§Ù„Ø§Ø³Ù…</span><strong>${d.name}</strong></div>
            <div class="detail-row"><span>Ø§Ù„Ù‡Ø§ØªÙ</span><strong dir="ltr">${d.phone}</strong></div>
            <div class="detail-row"><span>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¬Ø²</span><strong>${typeLabels[d.type] || d.type}</strong></div>
            ${extraHTML}
            <div class="detail-row"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØµÙˆÙ„</span><strong>${fmt(d.checkin)}</strong></div>
            <div class="detail-row"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©</span><strong>${fmt(d.checkout)}</strong></div>
            <div class="detail-row"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</span><strong>${d.numbers || 'â€”'}</strong></div>
            <div class="detail-row"><span>Ø§Ù„Ø­Ø§Ù„Ø©</span><strong>${statusLabels[d.status] || d.status}</strong></div>
            <div class="detail-row detail-row-full"><span>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span><p class="detail-message">${d.message || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}</p></div>
            <div class="detail-row"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</span><strong>${fmt(d.createdat)}</strong></div>
          </div>
          <div class="modal-actions">
            <button class="modal-action-btn btn-modal-confirm" onclick="updateStatus('${d.id}', 'confirmed'); closeModal();">
              <i class="fa-solid fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²
            </button>
            <button class="modal-action-btn btn-modal-cancel" onclick="updateStatus('${d.id}', 'cancelled'); closeModal();">
              <i class="fa-solid fa-xmark"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²
            </button>
          </div>
        `;
        document.getElementById('detailsModal').style.display = 'flex';
      });
    });

    function closeModal() {
      document.getElementById('detailsModal').style.display = 'none';
    }
    document.getElementById('detailsModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    // ===== Update Status =====
    async function updateStatus(id, status) {
      try {
        const res = await fetch(`/api/v1/booking/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        if (res.ok) {
          showToast(status === 'confirmed' ? 'âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­' : 'âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²', status === 'confirmed' ? 'success' : 'warning');
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
        }
      } catch { showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error'); }
    }

    // ===== Delete =====
    async function deleteBooking(id) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ')) return;
      try {
        const res = await fetch(`/api/v1/booking/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
        }
      } catch { showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error'); }
    }
